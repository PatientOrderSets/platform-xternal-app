Platform Xternal App
====================

This sample application will hopefully demonstrate how to get an application integrated with PatientOrdersets Platform.
Through the use of JWT and OAuth2 all applications should have access to API end points provided by our platform.

Libraries
---------

This project uses the following libraries:

1. [Devise](https://github.com/plataformatec/devise)    - A well known library for user authentication
2. [JSON-JWT](https://github.com/nov/json-jwt)          - A well maintained ruby JWT library parser
3. [OAuth2](https://github.com/intridea/oauth2)         - A ruby OAuth2 client library

Setting Up The Client Application
---------------------------------

### Authenticating the user

Assuming you're using Devise we need to apply a filter that will handle the JWT login process before the default Devise
logic kicks in. To do this we apply a `before_filter` before the application's Devise authenticate call. For example,
the sample application defines the authenticate call, thus the resulting `ApplicationController` should look like the
following:

~~~~ ruby
class ApplicationController < ActionController::Base
  # Prevent CSRF attacks by raising an exception.
  # For APIs, you may want to use :null_session instead.
  protect_from_forgery with: :exception

  before_filter :authenticate_user_from_ep_platform
  before_filter :authenticate_user!

  > ... other things go here ...

  def authenticate_user_from_ep_platform
    if params[:jwt]
      jwt_token = JSON::JWT.decode params[:jwt], Rails.configuration.doorkeeper_application_id

      # You will want to check to see if the JWT token is generated by the right application. That is,
      # you need to check that the aud, iss claims are what you expect. I've omitted here as this is just a
      # sample application.

      user = User.find_or_create_by(upn: jwt_token['upn']) do |user|
        user.first_name = jwt_token['first_name']
        user.last_name = jwt_token['first_name']
        user.email = jwt_token['email']
        user.doorkeeper_request_token = jwt_token['oauth_request_token']
      end

      user.save if user.changed?

      sign_in user
    end
  end
end
~~~~

How this works is that it will sign the user in and when the `before_filter :authenticate_user!` executes the application
already knows the user has been signed in and just lets the request go through.

This logic was taken from this [post](https://gist.github.com/josevalim/fb706b1e933ef01e4fb6) which describes how Devise
removed the `TokenAuthenticatable` strategy and shows how Devise users should be handling authentication through tokens.

### What's in the JWT

